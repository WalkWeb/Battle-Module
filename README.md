# Battle Module

Модуль командного, пошагового боя для браузерной игры. Так как вся игра пошаговая, и придерживается принципа 
ненапряженного геймплея, который можно в любой момент прекратить, а потом, когда будет удобно – продолжить, бои 
проходят в автоматическом режиме, а игроку лишь воспроизводится результат. Т.е. прямого управления над боем нет.

## Пример (1 на 1)

```php
use Battle\BattleFactory;
use Battle\View\ViewFactory;

$data = [
    [
        'id'           => '81941b8a-f7ca-447e-8951-36777ae6e79e',
        'name'         => 'Warrior',
        'level'        => 3,
        'avatar'       => '/images/avas/humans/human001.jpg',
        'damage'       => 25,
        'attack_speed' => 0.8,
        'accuracy'     => 200,
        'defense'      => 120,
        'block'        => 0,
        'block_ignore' => 0,
        'life'         => 110,
        'total_life'   => 110,
        'melee'        => true,
        'class'        => 1,
        'race'         => 1,
        'command'      => 1,
    ],
    [
        'id'           => 'bf75c4a3-b866-4787-88c7-8db57daf3d64',
        'name'         => 'Skeleton',
        'level'        => 2,
        'avatar'       => '/images/avas/monsters/005.png',
        'damage'       => 20,
        'attack_speed' => 1.2,
        'accuracy'     => 240,
        'defense'      => 150,
        'block'        => 0,
        'block_ignore' => 0,
        'life'         => 65,
        'total_life'   => 65,
        'melee'        => true,
        'class'        => null,
        'race'         => 8,
        'command'      => 2,
    ],
];

$battle = BattleFactory::create($data);
$result = $battle->handle();

$view = (new ViewFactory())->create($battle->getContainer()->getTranslation());
echo $view->renderHead(); // example layout styles
echo $view->renderResult($result);
```

## Как выглядит бой (2 на 3)

Плюс Dark Mage во время боя призвал скелета в свою (левую) команду

![alt text](public/images/battle.png)

### Итоговая статистика

![alt text](public/images/statistics.png)


Вы можете запустить и посмотреть пример боя открыв страницу:

`public/index.php`


## 100% покрытие кода unit-тестами

![alt text](public/images/test_code_coverage.png)

## GitLab CI

![alt text](public/images/gitlab-ci-cd.png)

## Архитектурные принципы

Модуль написан на принципах DDD:

- Имеет свой, независимый неймспейс `Battle`
- Написан полностью независимым от фреймворков, и прочих тяжелых зависимостей
- Изолированно выполняет свою задачу: принимает данные по сражающимся юнитам (это может быть как бой 1 на 1 так и
  команда на команду), обрабатывает бой и возвращает результат, на основании которого можно отобразить бой на фронте
- Классы в модуле полностью соответствуют «бизнес»-сущностям, а именно:
    - Бой обрабатывается в классе `Battle`
    - Сражающиеся две команды реализованы в классах `Command`
    - Команды состоят из юнитов (это могут быть как персонажи игроков, так и монстры), реализованных в классе `Unit`
    - Процесс боя проходит в раундах - классе `Round` в котором каждый живой юнит должен совершить свой ход. После того,
    как все юниты походили, начинается новый раунд
    - Раунд состоит из ходов одного юнита, и эти ходы реализованы в классах `Stroke`
    - Взаимодействие между юнитами построено на обмене абстрактных `Action` - это может быть как удар, так и лечение, 
    так и использование способности. При этом для внешних объектов совершенно не важно, что это - просто у одного юнита
    запрашивается коллекция его действий, и выполняется. При этом само действие определяет, на кого оно должно 
    примениться.
    - Результат боя сохраняется в `Result`
    - Статистика по бою сохраняется в `Statistic`
    - Класс отвечающий за мультиязычность - `Translation`
- Все важные зависимости завязаны на интерфейсы, а не на конкретные классы
- Большое внимание уделено тестам и проработке исключительных ситуаций. Покрытие кода тестами 100%

## Планы

- [Визуальный дефект] При отображении иконок эффектов, если у какой-то иконки не указана длительность (она больше 9), то
следующая иконка будет «наезжать» на неё
- Реализовать механику применения эффекта на всю команду (на всю вражескую команду реализовано, осталось сделать на всю
свою команду)
- Подумать над реализацией эффектов, которые могут активироваться/деактивироваться при определенном параметра юнита
- EffectAction добавить параметр buff: true/false указывающий на то, является ли это положительный или отрицательный 
эффект
- Добавить CancelBuffAction и CancelDebuffAction - отменяющие все положительные или все отрицательные эффекты
- Добавить возможность добавления способностей не только от класса, но и на прямую при создании юнита. Это позволит
создавать предметы, которые дают определенные боевые способности
- Добавить способностям параметр актуальности, чтобы в случае одновременной активации двух способностей - использовалась
наиболее актуальная
- Реализовать создание способности через массив параметров
- Реализовать создание способности по id (и, в будущем, уровню)
- Реализовать создание класса через массив параметров
- Реализовать механику уровней способностей у класса
- Добавить особые способности рас: орки двойной урон на низком уровне здоровья, эльфы - способность уклониться от атак,
люди - шанс избежать смерти и восстановить 50% здоровья
- Добавить больше разнообразных способностей
- Расширить варианты классов, добавив новым классам новые варианты способностей
- Переделать простой int урон на объект Damage с расширенными параметрами, такие как шанс крита, сила крита, стихии 
урона и т.д.
- Реализовать расширенный вариант защитных параметров defense - с такими параметрами как шанс блока, уклонение, 
сопротивления различным стихиям
- Сделать сайт-пример с боем
- Добавить ману
- Добавить параметр магического щита - когда часть урона идет по мане, перед здоровьем
- Сделать все аватары повернутыми вправо, а у правой команды через css разворачивать их по горизонтали, таким образом
все юниты будут смотреть друг на друга
- Добавить механику увеличения урона, в слишком долгих боях
- Добавить развертывание через Docker
- Перевести все комментарии в коде на английский
- Фиксированное количество сражающихся команд увеличить на любое, больше 2-х - это позволит делать не только бой 1 на 1
  или команда на команду, а например бои с 5 участниками в формате каждый сам за себя
- И многое другое

## Реализованные характеристики

План по реализации характеристик юнитов. По этому списку можно оценить навороченность запланированной боевой механики.

- [x] `id` – id юнита
- [x] `side` – Сторона (правая или левая) за которую сражается юнит
- [x] `row` – 1 или 2 ряд в бою. Юниты ближнего боя располагаются в 1 ряду, юниты дальнего боя - во 2 ряду
- [x] `already action` – Этот параметр указывает, ходил ли юнит в текущем раунде
- [x] `avatar` – Путь к аватару юнита
- [x] `name` – Имя юнита
- [x] `level` – Уровень юнита
- [x] `life` – Текущий и максимальный запас здоровья юнита
- [ ] `mana` – Текущий и максимальный запас маны юнита.
- [ ] `mental barrier` – Если юнит имеет ментальный барьер, то урон вначале будет идти по мане, и только потом по здоровью
- [x] `physical damage` (base damage) – Физический урон
- [ ] `fire damage` – Урон стихией огня
- [ ] `water damage` – Урон стихией вод
- [ ] `air damage` – Урон стихией воздуха
- [ ] `earth damage` – Урон стихией земли
- [ ] `life damage` – Урон магией жизни
- [ ] `death damage` – Урон магией смерти
- [ ] `physical resist` – Сопротивление физическому урону
- [ ] `fire resist` – Сопротивление урону огнем
- [ ] `water resist` – Сопротивление урону водой
- [ ] `air resist` – Сопротивление урону воздухом
- [ ] `earth resist` – Сопротивление урону землей
- [ ] `life resist` – Сопротивление урону магией жизни
- [ ] `death resist` – Сопротивление урону магией смерти
- [ ] `physical max resist` – Максимальное сопротивление физическому урону
- [ ] `fire max resist` – Максимальное сопротивление урону огнем
- [ ] `water max resist` – Максимальное сопротивление урону водой
- [ ] `air max resist` – Максимальное сопротивление урону воздухом
- [ ] `earth max resist` – Максимальное сопротивление урону землей
- [ ] `life max resist` – Максимальное сопротивление урону магией жизни
- [ ] `death max resist` – Максимальное сопротивление урону магией смерти
- [x] `accuracy` – Меткость, влияет на шанс попадания по противнику атаками
- [ ] `magic accuracy` – Магическая меткость, влияет на шанс попадания по противнику заклинаниями
- [x] `defense` – Защита, влияет на шанс уклониться от удара противника
- [ ] `magic defense` – Магическая защита, влияет на шанс уклониться от заклинания противника
- [ ] `critical chance` – Шанс критического удара
- [ ] `critical multiplier` – Сила критического удара
- [ ] `damage type` – Тип удара: атака или заклинание
- [ ] `weapon type` – Тип используемого оружия. Некоторые типы оружия могут при ударе наложить на цель дополнительный 
эффект, например: кинжалы могут вызвать кровотечение, а дробящее оружие оглушить врага
- [x] `attack speed` – Скорость атаки. Рассчитывается следующим образом: attack speed 1.3 означает, что юнит 100% нанесет 
один удар в своем ходе, и с 30% вероятностью еще один удар в этом же ходу. А attack speed 0.7 означает, что юнит с 70%
вероятностью нанесет урон, а с 30% вероятностью ничего не сделает, а в чате отобразится сообщение «юнит готовится к 
атаке»
- [ ] `cast speed` – Скорость создания заклинаний. Механика аналогична скорости атаки, только относится к типу удара 
заклинание
- [x] `block` – Шанс заблокировать атаку противника
- [ ] `magic block` – Шанс заблокировать заклинание противника
- [x] `block ignore` – Игнорирование блока. Некоторые типы оружия настолько тяжелые, что могут полностью игнорировать блок
- [ ] `dodge` – Уклонение. Вероятность избежать удара или заклинания противника. Не зависит от меткости противника
- [x] `concentration` – Концентрация. Постепенно накапливается в бою и при полном заполнении позволяет использовать 
способности требующую концентрацию
- [x] `cunning` – Хитрость. С некоторой вероятностью позволяет активировать способности относящихся к типу хитрости. 
Базовое значение: 15
- [x] `rage` – Ярость. Постепенно накапливается в бою и при полном заполнении позволяет использовать способности требующие 
ярость
- [ ] `add concentration` – Отвечает за множитель получаемой концентрации
- [ ] `add cunning` – Отвечает за множитель хитрости
- [ ] `add rage` – Отвечает за множитель получаемой ярости
- [x] `race name` – Название расы юнита
- [x] `race color` – Цвет расы юнита. Используется для цветового выделения имени юнита
- [ ] `race ability` – Способности расы
- [x] `class name` – Название класса юнита
- [x] `class abilities` – Способности класса
- [ ] `global damage resist` – Общий множитель получаемого урона
- [ ] `vampire` – Позволяет воровать часть нанесенного урона в здоровье
- [ ] `magic vampire` – Позволяет воровать часть нанесенного урона в ману

Всего 65 характеристик. Вместе с гибкой [системой эффектов](https://github.com/WalkWeb/Battle-Module/tree/master/src/Battle/Unit/Effect) 
это позволит создавать практически неограниченное количество игровых механик.
